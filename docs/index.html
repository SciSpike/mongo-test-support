<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Home</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Home</h1>

    



    


    <h3> </h3>










    




    <section>
        <article><h1><code>mongo-test-support</code></h1>
<p>Handy-dandy Mongo integration testing utility that starts a local Docker container running Mongo if you're not running in a CI/CD pipeline.
This allows you to run integration tests locally in a manner similar to how they'd be run in the CI/CD pipeline.
This module does nothing when running in a CI build pipeline, because Mongo should be configured as part of the build via something like <a href="https://docs.gitlab.com/ee/ci/yaml/#services"><code>.gitlab-ci.yml</code>'s <code>services</code></a> element.</p>
<p>This package is intended to be installed in your project in <code>devDependencies</code>.</p>
<p>Your application must install its desired versions of <a href="https://www.npmjs.com/package/mongodb"><code>mongodb</code></a> and/or <a href="https://www.npmjs.com/package/mongoose">mongoose</a>.</p>
<blockquote>
<p>NOTE: requires a Unix-y shell (<code>/usr/bin/env sh</code>) to be available.
This is not designed to run on Windows; PRs/MRs welcome.</p>
</blockquote>
<p>Usage:</p>
<pre class="prettyprint source lang-javascript"><code>const { mongoConnect } = require('@ballistagroup/mongo-test-support')

const db = await mongoConnect()

// now you can do db.createCollection(), etc
// db.client is mongo client
</code></pre>
<p>Usage to work in both local environment &amp; CI pipeline:</p>
<pre class="prettyprint source lang-javascript"><code>const { mongoConnect } = require('@ballistagroup/mongo-test-support')
const db = await mongoConnect(process.env.CI_COMMIT_SHA ? { host: 'mongo', port: 27017 } : undefined)
</code></pre>
<p>You can also drop collections:</p>
<pre class="prettyprint source lang-javascript"><code>const { dropCollections } = require('@ballistagroup/mongo-test-support')
await dropCollections({db}) // drops all collections
await dropCollections({db, names: ['foos', 'bars']}) // drops named collections
await dropCollections({db, names: []}) // no collections dropped
</code></pre>
<h2>Configuration</h2>
<p>The default configuration is pretty conventional, with the sole exception of the default port that Mongo will listen on for clients.
Instead of <code>27017</code>, which might already be in use on developers' machines when they run integration tests, the default configuration uses <code>37017</code>.
It is a <code>TODO</code> to search for an available port.</p>
<blockquote>
<p>NOTE: This module detects when it's running in a CI/CD pipeline by seeing if the environment variable <code>CI_COMMIT_SHA</code> or <code>GITHUB_SHA</code> is of nonzero length.</p>
</blockquote>
<h3>Environment variables</h3>
<p>The following environment variables can be set to configure the docker container:</p>
<ul>
<li>MONGO_TEST_SUPPORT_TAG: The tag of the <a href="https://hub.docker.com/_/mongo"><code>mongo</code> Docker image</a>  or custom image to use, default <code>latest</code></li>
<li>MONGO_TEST_SUPPORT_PORT: visible client port on <code>localhost</code> to map to container port, default is content of <code>mongo/default-mongo-test-port</code></li>
<li>MONGO_TEST_SUPPORT_CONTAINER: name of container, default is content of file <code>mongo/default-mongo-test-container</code></li>
<li>MONGO_TEST_SUPPORT_CONTAINER_PORT: mongo client port in container, default <code>9042</code></li>
<li>MONGO_TEST_SUPPORT_IMAGE: docker image name, default <code>mongo</code></li>
</ul></article>
    </section>






</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#dropCollections">dropCollections</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.11</a> on Mon Oct 03 2022 23:07:27 GMT-0500 (Central Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>